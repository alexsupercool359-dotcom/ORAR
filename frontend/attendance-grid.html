<!DOCTYPE html>
<html lang="ro">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tabel PrezenÈ›e SÄƒptÄƒmÃ¢ni 1-7</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .grid-container {
            overflow-x: auto;
            margin: 20px 0;
        }
        .attendance-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .attendance-table th {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 15px;
            text-align: center;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        .attendance-table td {
            padding: 12px;
            border: 1px solid #e0e0e0;
            text-align: center;
        }
        .class-info-cell {
            text-align: left;
            font-weight: 600;
            background: #f9f9f9;
            position: sticky;
            left: 0;
            z-index: 5;
        }
        .class-details {
            font-size: 12px;
            color: #666;
            margin-top: 4px;
        }
        .checkbox-cell {
            background: white;
            transition: background 0.3s;
        }
        .checkbox-cell input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }
        .checkbox-cell.checked {
            background: #c8e6c9;
            border: 2px solid #4CAF50;
        }
        .checkbox-cell.absent {
            background: #ffebee;
        }
        .week-past {
            opacity: 0.7;
        }
        .week-header {
            font-size: 14px;
        }
        .week-type {
            display: block;
            font-size: 11px;
            opacity: 0.8;
            margin-top: 2px;
        }
        .subject-row {
            background: #f0f4ff;
            font-weight: bold;
            color: #667eea;
        }
        .stats-summary {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        .stat-card {
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
            background: #f9f9f9;
        }
        .stat-name {
            font-size: 14px;
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
        }
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #667eea;
        }
        .stat-label {
            font-size: 12px;
            color: #666;
            margin-top: 4px;
        }
        .save-section {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            padding: 20px;
            box-shadow: 0 -4px 20px rgba(0,0,0,0.1);
            display: flex;
            justify-content: center;
            gap: 15px;
            z-index: 1000;
        }
    </style>
</head>
<body style="padding-bottom: 100px;">
    <div class="container" style="max-width: 100%; padding: 20px;">
        <header>
            <h1>ğŸ“‹ Tabel PrezenÈ›e SÄƒptÄƒmÃ¢ni 1-7</h1>
            <p style="opacity: 0.9; margin-top: 10px;">
                BifeazÄƒ DOAR orele la care ai fost prezent efectiv
            </p>
        </header>

        <div style="margin-top: 30px;">
            <div class="info-text">
                ğŸ’¡ <strong>Cum funcÈ›ioneazÄƒ:</strong> BifeazÄƒ checkbox-ul pentru fiecare orÄƒ la care ai fost prezent.
                LasÄƒ nebifat dacÄƒ ai lipsit. DupÄƒ ce termini, apasÄƒ "SalveazÄƒ È™i Vezi RecomandÄƒri".
            </div>

            <div class="stats-summary" id="statsSummary" style="display: none;">
                <h3>ğŸ“Š Statistici Live</h3>
                <div class="stats-grid" id="statsGrid"></div>
            </div>

            <div class="grid-container">
                <table class="attendance-table" id="attendanceTable">
                    <thead>
                        <tr>
                            <th style="min-width: 250px;">OrÄƒ</th>
                            <th class="week-header">
                                SÄƒptÄƒmÃ¢na 1
                                <span class="week-type">IMPARÄ‚ (SI)</span>
                            </th>
                            <th class="week-header">
                                SÄƒptÄƒmÃ¢na 2
                                <span class="week-type">PARÄ‚ (SP)</span>
                            </th>
                            <th class="week-header">
                                SÄƒptÄƒmÃ¢na 3
                                <span class="week-type">IMPARÄ‚ (SI)</span>
                            </th>
                            <th class="week-header">
                                SÄƒptÄƒmÃ¢na 4
                                <span class="week-type">PARÄ‚ (SP)</span>
                            </th>
                            <th class="week-header">
                                SÄƒptÄƒmÃ¢na 5
                                <span class="week-type">IMPARÄ‚ (SI)</span>
                            </th>
                            <th class="week-header">
                                SÄƒptÄƒmÃ¢na 6
                                <span class="week-type">PARÄ‚ (SP)</span>
                            </th>
                            <th class="week-header">
                                SÄƒptÄƒmÃ¢na 7
                                <span class="week-type">IMPARÄ‚ (SI)</span>
                            </th>
                        </tr>
                    </thead>
                    <tbody id="tableBody">
                        <tr>
                            <td colspan="8" style="text-align: center; padding: 40px;">
                                Se Ã®ncarcÄƒ orarul...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="save-section">
            <button class="btn btn-secondary btn-large" onclick="calculateStats()">
                ğŸ“Š CalculeazÄƒ Statistici
            </button>
            <button class="btn btn-secondary btn-large" onclick="window.location.href='/setup-schedule.html'">
                âœï¸ EditeazÄƒ Orar
            </button>
            <button class="btn btn-primary btn-large" onclick="saveAttendance()">
                ğŸ’¾ SalveazÄƒ È™i Vezi RecomandÄƒri
            </button>
        </div>
    </div>

    <script>
        let personalSchedule = {};
        let attendance = {};

        // Load personal schedule and existing attendance
        async function loadData() {
            try {
                // Load schedule
                const scheduleRes = await fetch('/api/schedule/personal');
                personalSchedule = await scheduleRes.json();

                // Load existing attendance
                try {
                    const attendanceRes = await fetch('/data/attendance_grid.json');
                    if (attendanceRes.ok) {
                        attendance = await attendanceRes.json();
                        console.log('Loaded existing attendance:', attendance);
                    }
                } catch (err) {
                    console.log('No existing attendance found, starting fresh');
                }

                renderTable();

                // Auto-check loaded attendance
                setTimeout(() => {
                    Object.entries(attendance).forEach(([cellId, data]) => {
                        if (data.checked) {
                            const checkbox = document.getElementById(cellId);
                            if (checkbox) {
                                checkbox.checked = true;
                                const cell = document.querySelector(`[data-cell-id="${cellId}"]`);
                                if (cell) cell.classList.add('checked');
                            }
                        }
                    });
                    calculateStats(); // Show stats automatically
                }, 100);

            } catch (err) {
                console.error('Error:', err);
                document.getElementById('tableBody').innerHTML = `
                    <tr>
                        <td colspan="8" style="text-align: center; padding: 40px;">
                            âŒ Nu ai configurat Ã®ncÄƒ orarul!<br><br>
                            <a href="/setup-schedule.html" style="color: #667eea;">
                                ğŸ‘‰ CreeazÄƒ Orarul Acum
                            </a>
                        </td>
                    </tr>
                `;
            }
        }

        // Call loadData on page load
        loadData();

        function renderTable() {
            const tbody = document.getElementById('tableBody');
            let html = '';

            Object.entries(personalSchedule).forEach(([key, subject]) => {
                if (subject.classes.length === 0) return;

                // Subject header row
                html += `
                    <tr class="subject-row">
                        <td colspan="8">${subject.name} (${subject.frequency === 'weekly' ? 'SÄƒptÄƒmÃ¢nal' : 'O datÄƒ la 2 sÄƒptÄƒmÃ¢ni'})</td>
                    </tr>
                `;

                // Class rows
                subject.classes.forEach((cls, idx) => {
                    html += `<tr>`;

                    // Class info column
                    html += `
                        <td class="class-info-cell">
                            <div>${cls.day} ${cls.time_start}-${cls.time_end}</div>
                            <div class="class-details">
                                ${cls.type} | ${cls.room}
                                ${cls.week_type ? ` | ${cls.week_type}` : ''}
                            </div>
                        </td>
                    `;

                    // Checkboxes for weeks 1-7
                    for (let week = 1; week <= 7; week++) {
                        const weekType = week % 2 === 1 ? 'SI' : 'SP';
                        const cellId = `${cls.id}_week${week}`;

                        // Check if this class is available this week
                        let isAvailable = true;
                        if (cls.week_type && cls.week_type !== weekType) {
                            isAvailable = false;
                        }

                        if (isAvailable) {
                            html += `
                                <td class="checkbox-cell" data-cell-id="${cellId}">
                                    <input type="checkbox"
                                           id="${cellId}"
                                           data-subject="${key}"
                                           data-class-id="${cls.id}"
                                           data-week="${week}"
                                           onchange="toggleAttendance('${cellId}', '${key}', this.checked)">
                                </td>
                            `;
                        } else {
                            html += `<td style="background: #f0f0f0;">-</td>`;
                        }
                    }

                    html += `</tr>`;
                });
            });

            tbody.innerHTML = html;
        }

        function toggleAttendance(cellId, subject, checked) {
            const cell = document.querySelector(`[data-cell-id="${cellId}"]`);
            if (checked) {
                cell.classList.add('checked');
                cell.classList.remove('absent');
                attendance[cellId] = {
                    subject,
                    checked: true
                };
            } else {
                cell.classList.remove('checked');
                cell.classList.add('absent');
                delete attendance[cellId];
            }
        }

        function calculateStats() {
            const stats = {};

            // Initialize stats
            Object.entries(personalSchedule).forEach(([key, subject]) => {
                if (subject.classes.length === 0) return;

                const requiredCount = subject.frequency === 'weekly' ? 14 : 7;
                stats[subject.name] = {
                    attended: 0,
                    required: requiredCount,
                    frequency: subject.frequency
                };
            });

            // Count attendance
            Object.entries(attendance).forEach(([cellId, data]) => {
                const subject = personalSchedule[data.subject];
                if (subject) {
                    stats[subject.name].attended++;
                }
            });

            displayStats(stats);
        }

        function displayStats(stats) {
            const statsBox = document.getElementById('statsSummary');
            const statsGrid = document.getElementById('statsGrid');

            let html = '';
            Object.entries(stats).forEach(([name, stat]) => {
                const remaining = stat.required - stat.attended;
                const percentage = Math.round((stat.attended / stat.required) * 100);

                html += `
                    <div class="stat-card">
                        <div class="stat-name">${name}</div>
                        <div class="stat-value">${stat.attended}/${stat.required}</div>
                        <div class="stat-label">${percentage}% | RÄƒmÃ¢n: ${remaining}</div>
                    </div>
                `;
            });

            statsGrid.innerHTML = html;
            statsBox.style.display = 'block';
            statsBox.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        async function saveAttendance() {
            if (Object.keys(attendance).length === 0) {
                alert('âŒ Nu ai bifat nicio prezenÈ›Äƒ! BifeazÄƒ cel puÈ›in o orÄƒ.');
                return;
            }

            try {
                const response = await fetch('/api/attendance/grid', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ attendance })
                });

                if (response.ok) {
                    alert('âœ… PrezenÈ›e salvate cu succes!');
                    window.location.href = '/recommendations.html';
                } else {
                    alert('âŒ Eroare la salvare. ÃncearcÄƒ din nou.');
                }
            } catch (err) {
                console.error('Error:', err);
                alert('âŒ Eroare la salvare. ÃncearcÄƒ din nou.');
            }
        }
    </script>
</body>
</html>
